version: 2.1
jobs:
  test:
    # This is a parameterized job
    # https://circleci.com/docs/2.0/reusing-config/#authoring-parameterized-jobs
    parameters:
      directory:
        type: string
      go-image-tag:
        type: string
        default: "1.21-jammy"
    description: "test at << parameters.directory >>"
    docker:
      - image: quay.io/cybozu/golang:<<parameters.go-image-tag>>
      - image: quay.io/cybozu/etcd:3.5.7.1
    working_directory: /work
    steps:
      - checkout
      - run: apt-get update
      - run: make -C << parameters.directory >> check-generate SUDO=
      - run: make -C << parameters.directory >> test SUDO=
  build:
    # This is a parameterized job
    # https://circleci.com/docs/2.0/reusing-config/#authoring-parameterized-jobs
    parameters:
      container-image:
        type: string
      dir:
        type: string
        default: ""
      attach:
        type: boolean
        default: false
      targets:
        type: string
        default: ""
      resource-class:
        type: string
        default: medium
      scan:
        type: boolean
        default: false
    description: "build << parameters.container-image >>"
    working_directory: /app
    docker:
      - image: docker:stable
    resource_class: << parameters.resource-class >>
    steps:
      - run:
          name: Install tools
          command: |
            apk add --no-cache curl jq git
      - checkout
      - when:
          condition: << parameters.attach >>
          steps:
            - attach_workspace:
                at: /app/<< parameters.dir >>/workspace
      - setup_remote_docker
      - run:
          name: Check TAG files
          command: |
            dir=<< parameters.dir >>
            if [ "$dir" = "" ]; then dir=<< parameters.container-image >> ; fi
            image=<< parameters.container-image >>
            targets="<< parameters.targets >>"
            if [ "$targets" != "" ]; then
              for target in $targets; do break; done # get first element
              image=$image-$target
            fi
            c="$(./tag_exists $image $dir)"
            if [ "$c" = ng ]; then
                echo << parameters.container-image >> > BUILDS
            fi
      - run:
          name: Validate consistency between BRANCH and TAG
          command: |
            dir=<< parameters.dir >>
            if [ "$dir" = "" ]; then dir=<< parameters.container-image >> ; fi
            if [ -e "$dir/NO_TAG_BRANCH_CONSISTENCY" ]; then exit 0; fi
            ./tag_branch_consistency $dir
      - run:
          name: Build images
          no_output_timeout: 20m
          command: |
            if [ ! -f BUILDS ]; then
                echo "no need to build << parameters.container-image >>."
                exit 0
            fi
            echo "building << parameters.container-image >> ..."
            dir=<< parameters.dir >>
            if [ "$dir" = "" ]; then dir=<< parameters.container-image >> ; fi
            docker build -t quay.io/cybozu/<< parameters.container-image >>:latest $dir
            targets="<< parameters.targets >>"
            if [ "$targets" != "" ]; then
              for target in $targets; do
                docker build -t quay.io/cybozu/<< parameters.container-image >>-$target:latest --target $target $dir
              done
            fi
            docker images
      - deploy:
          name: Push Docker image to Quay.io
          command: |
            if [ "${CIRCLE_BRANCH}" != "main" ]; then
                exit 0
            fi
            if [ ! -f BUILDS ]; then
                exit 0
            fi
            docker login -u $QUAY_USER -p $QUAY_PASSWORD quay.io
            echo
            echo "pushing << parameters.container-image >> ..."
            dir=<< parameters.dir >>
            if [ "$dir" = "" ]; then dir=<< parameters.container-image >> ; fi
            targets="<< parameters.targets >>"
            if [ "$targets" = "" ]; then
              images=<< parameters.container-image >>
            else
              images=
              for target in $targets; do
                images="$images << parameters.container-image >>-$target"
              done
            fi
            TAG=$(cat $dir/TAG)
            for image in $images; do
              docker tag quay.io/cybozu/$image:latest quay.io/cybozu/$image:$TAG
              docker push quay.io/cybozu/$image:$TAG
            done
            if echo $TAG | grep -q -e - ; then
                echo ===== Skip pushing branch tags for pre-release $TAG =====
                exit 0
            fi
            for image in $images; do
              if [ -f $dir/BRANCH ]; then
                  BRANCH=$(cat $dir/BRANCH)
                  docker tag quay.io/cybozu/$image:$TAG quay.io/cybozu/$image:$BRANCH
                  docker push quay.io/cybozu/$image:$BRANCH
              fi
            done
      - when:
          condition: << parameters.scan >>
          steps:
            - run:
                name: Install Trivy
                command: |
                  curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
            - run:
                name: Scan images
                command: |
                  if [ "${CIRCLE_BRANCH}" != "main" ]; then
                      exit 0
                  fi
                  if [ ! -f BUILDS ]; then
                      echo "no need to scan << parameters.container-image >>."
                      exit 0
                  fi
                  
                  dir=<< parameters.dir >>
                  if [ "$dir" = "" ]; then dir=<< parameters.container-image >> ; fi
                  targets="<< parameters.targets >>"
                  if [ "$targets" = "" ]; then
                      images=<< parameters.container-image >>
                  else
                      images=
                      for target in $targets; do
                          images="$images << parameters.container-image >>-$target"
                      done
                  fi
                  TAG=$(cat $dir/TAG)
                  for image in $images; do
                      echo "scanning $image:$TAG ..."
                      YAMORY_IMAGE_IDENTIFIER="quay.io/cybozu/$image" YAMORY_IMAGE_NAME="quay.io/cybozu/$image:$TAG" sh -c "$(curl -sSf -L https://mw-receiver.yamory.io/image/script/trivy)"
                  done
  buildx:
    # This is a parameterized job
    # https://circleci.com/docs/2.0/reusing-config/#authoring-parameterized-jobs
    parameters:
      container-image:
        type: string
      dir:
        type: string
        default: ""
      attach:
        type: boolean
        default: false
      resource-class:
        type: string
        default: medium
    description: "build << parameters.container-image >>"
    docker:
      - image: cimg/base:current-20.04
    resource_class: << parameters.resource-class >>
    steps:
      - run:
          name: Install tools
          command: |
            sudo apt-get update
            sudo apt-get install -y curl jq git
            CONTAINER_TAG_EXISTS_VERSION=1.0.3
            curl -fsSL -o container-tag-exists.tar.gz \
              https://github.com/Hsn723/container-tag-exists/releases/download/v${CONTAINER_TAG_EXISTS_VERSION}/container-tag-exists_${CONTAINER_TAG_EXISTS_VERSION}_linux_amd64.tar.gz
            sudo tar -xzf container-tag-exists.tar.gz -C /usr/local/bin
            rm -f container-tag-exists.tar.gz
            curl -LO https://storage.googleapis.com/container-structure-test/v1.14.0/container-structure-test-linux-amd64 \
              && chmod +x container-structure-test-linux-amd64 \
              && sudo mv container-structure-test-linux-amd64 /usr/local/bin/container-structure-test
      - checkout
      - when:
          condition: << parameters.attach >>
          steps:
            - attach_workspace:
                at: ./<< parameters.dir >>/workspace
      - setup_remote_docker:
          version: 20.10.18
      # The binfmt container image is not an official image, so we use a pinned version(qemu-v6.2.0).
      - run: docker run --rm --privileged tonistiigi/binfmt@sha256:5bf63a53ad6222538112b5ced0f1afb8509132773ea6dd3991a197464962854e --install linux/amd64,linux/arm64/v8
      - run:
          name: Check TAG files
          command: |
            dir=<< parameters.dir >>
            if [ "$dir" = "" ]; then dir=<< parameters.container-image >> ; fi
            image=<< parameters.container-image >>
            tag=$(cat ${dir}/TAG)
            c=$(container-tag-exists quay.io/cybozu/$image $tag 2>&1)
            # The stderr should be either "" or "found".
            # If the stderr was an error message other than "found", this step must have stopped due to the shell option "-e".
            if [ "$c" = "" ]; then
                echo quay.io/cybozu/$image >> BUILDS
            fi
      - run:
          name: Validate consistency between BRANCH and TAG
          command: |
            dir=<< parameters.dir >>
            if [ "$dir" = "" ]; then dir=<< parameters.container-image >> ; fi
            if [ -e "$dir/NO_TAG_BRANCH_CONSISTENCY" ]; then exit 0; fi
            ./tag_branch_consistency $dir
      - run:
          name: Test container structure
          command: |
            if [ ! -f BUILDS ]; then
                exit 0
            fi
            image=<< parameters.container-image >>
            dir=<< parameters.dir >>
            if [ "$dir" = "" ]; then dir=<< parameters.container-image >> ; fi
            if [ ! -e "$dir/container-structure-test.yaml" ]; then exit 0; fi
            echo "testing container structure: << parameters.container-image >> ..."
            TAG=$(cat $dir/TAG)
            for platform in linux/amd64 linux/arm64/v8; do
              docker context create structure
              docker buildx create structure --use
              docker buildx build \
                --progress plain \
                --load \
                --platform $platform \
                -t quay.io/cybozu/$image:$TAG \
                ${dir}
              container-structure-test test \
                --image quay.io/cybozu/$image:$TAG \
                --config ${dir}/container-structure-test.yaml
              docker buildx rm
              docker context rm structure
            done
      - run:
          name: Build test
          command: |
            if [ "${CIRCLE_BRANCH}" = "main" ]; then
                exit 0
            fi
            if [ ! -f BUILDS ]; then
                exit 0
            fi
            echo "building test: << parameters.container-image >> ..."
            image=<< parameters.container-image >>
            dir=<< parameters.dir >>
            if [ "$dir" = "" ]; then dir=<< parameters.container-image >> ; fi
            docker context create buildx
            docker buildx create buildx --use
            docker buildx build \
              --progress plain \
              --platform linux/amd64,linux/arm64/v8 \
              -o type=tar,dest=$image.tar \
              ${dir}
      - run:
          name: Build and Push
          command: |
            if [ "${CIRCLE_BRANCH}" != "main" ]; then
                exit 0
            fi
            if [ ! -f BUILDS ]; then
                exit 0
            fi
            docker login -u $QUAY_USER -p $QUAY_PASSWORD quay.io
            echo
            echo "building and pushing << parameters.container-image >> ..."
            image=<< parameters.container-image >>
            dir=<< parameters.dir >>
            if [ "$dir" = "" ]; then dir=<< parameters.container-image >> ; fi
            TAG=$(cat $dir/TAG)
            if [ -f $dir/BRANCH ]; then
              if echo $TAG | grep -q -e - ; then
                echo ===== Skip pushing branch tags for pre-release $TAG =====
              else
                BRANCH=$(cat $dir/BRANCH)
                BRANCH_TAG_OPTION="-t quay.io/cybozu/$image:$BRANCH"
              fi
            fi
            docker context create buildx
            docker buildx create buildx --use
            docker buildx build \
              --progress plain \
              --push \
              --platform linux/amd64,linux/arm64/v8 \
              -t quay.io/cybozu/$image:$TAG \
              ${BRANCH_TAG_OPTION} \
              ${dir}
  build-ceph:
    parameters:
      version:
        type: string
    docker:
      - image: quay.io/cybozu/ubuntu-dev:20.04
    resource_class: 2xlarge+
    steps:
      - checkout
      - run:
          name: Check TAG file
          command: |
            ceph_tag_exists="$(./tag_exists ceph)"
            if [ "$ceph_tag_exists" = ng ]; then
                echo ceph > BUILDS
            fi
      - run:
          name: Build Ceph packages
          command: |
            mkdir -p src/workspace
            if [ ! -f BUILDS ]; then
              # fake for the next step
              cd src/workspace
              touch COPYING
              exit 0
            fi
            ceph/build.sh << parameters.version >>
      - persist_to_workspace:
          root: src/workspace
          paths:
            - "*"
  build-envoy:
    parameters:
      version:
        type: string
      bazel-version:
        type: string
    docker:
      - image: quay.io/cybozu/ubuntu-dev:20.04
    resource_class: 2xlarge+
    steps:
      - checkout
      - run:
          name: Check TAG file
          command: |
            c="$(./tag_exists envoy)"
            if [ "$c" = ng ]; then
                echo envoy > BUILDS
            fi
      - run:
          name: Install dependency packages
          command: |
            if [ ! -f BUILDS ]; then exit 0; fi
            apt-get update
            apt-get -y install build-essential \
              libtool \
              cmake \
              automake \
              autoconf \
              make \
              ninja-build \
              curl \
              unzip \
              virtualenv \
              zlib1g-dev
            ln -s $(which python3) /usr/local/bin/python
      - run:
          name: Install Bazel
          command: |
            if [ ! -f BUILDS ]; then exit 0; fi
            curl -o /tmp/bazel.deb -sLf https://github.com/bazelbuild/bazel/releases/download/<< parameters.bazel-version >>/bazel_<< parameters.bazel-version >>-linux-x86_64.deb
            dpkg -i /tmp/bazel.deb
            rm -f /tmp/bazel.deb
      - run:
          name: Build envoy
          command: |
            mkdir -p src/workspace
            if [ ! -f BUILDS ]; then
                # fake for the next step
                cd src/workspace
                touch envoy LICENSE docker-entrypoint.sh
                exit 0
            fi
            cd src
            git clone --depth 1 --branch v<< parameters.version >> https://github.com/envoyproxy/envoy
            curl -o /tmp/clang.tar.xz -sLf https://github.com/llvm/llvm-project/releases/download/llvmorg-14.0.0/clang+llvm-14.0.0-x86_64-linux-gnu-ubuntu-18.04.tar.xz
            mkdir llvm
            tar -C llvm --strip-components=1 --no-same-owner -xf /tmp/clang.tar.xz
            cd envoy
            bazel/setup_clang.sh $(pwd)/../llvm
            echo "build --config=clang" >> user.bazelrc
            sed -i s/envoy_dependencies_extra\(\)/envoy_dependencies_extra\(ignore_root_user_error=True\)/ WORKSPACE
            bazel --bazelrc=/dev/null build --jobs=20 -c opt //source/exe:envoy-static.stripped
            mv bazel-bin/source/exe/envoy-static.stripped ../workspace/envoy
            mv LICENSE ../workspace
            mv ci/docker-entrypoint.sh ../workspace
      - persist_to_workspace:
          root: src/workspace
          paths:
            - "*"
  build-cilium-envoy:
    parameters:
      version:
        type: string
    docker:
      - image: quay.io/cybozu/ubuntu-dev:20.04
    resource_class: 2xlarge+
    steps:
      - checkout
      - run:
          name: Check TAG file
          command: |
            c="$(./tag_exists cilium)"
            if [ "$c" = ng ]; then
                echo cilium > BUILDS
            fi
      - run:
          name: Install package dependencies
          command: |
            if [ ! -f BUILDS ]; then exit 0; fi
            apt-get update
            apt-get install -y --no-install-recommends \
              ca-certificates \
              autoconf \
              automake \
              cmake \
              coreutils \
              curl \
              git \
              libtool \
              make \
              ninja-build \
              patch \
              patchelf \
              python3 \
              python-is-python3 \
              unzip \
              virtualenv \
              wget \
              zip
            wget -qO- https://apt.llvm.org/llvm-snapshot.gpg.key | tee /etc/apt/trusted.gpg.d/apt.llvm.org.asc
            echo "deb http://apt.llvm.org/focal/ llvm-toolchain-focal-15 main" >> /etc/apt/sources.list
            echo "deb-src http://apt.llvm.org/focal/ llvm-toolchain-focal-15 main" >> /etc/apt/sources.list
            apt-get update
            apt-get install -y --no-install-recommends \
              clang-15 \
              clang-tools-15 \
              lldb-15 \
              lld-15 \
              clang-format-15 \
              libc++-15-dev \
              libc++abi-15-dev
            apt-get purge --auto-remove
            apt-get clean
            rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*
      - run:
          name: Download cilium/proxy
          command: |
            mkdir -p src/workspace/usr/bin src/cilium-proxy
            if [ ! -f BUILDS ]; then exit 0; fi
            curl -sSLf https://github.com/cilium/proxy/archive/<< parameters.version >>.tar.gz | \
              tar zxf - --strip-components 1 -C src/cilium-proxy
      - run:
          name: Install bazel
          command: |
            if [ ! -f BUILDS ]; then exit 0; fi
            BAZEL_VERSION="$(cat src/cilium-proxy/.bazelversion)"
            curl -sfL https://github.com/bazelbuild/bazel/releases/download/${BAZEL_VERSION}/bazel-${BAZEL_VERSION}-linux-x86_64 -o /usr/bin/bazel
            chmod +x /usr/bin/bazel
      - run:
          name: Build cilium-envoy
          environment:
            BAZEL_BUILD_OPTS: "--remote_upload_local_results=false --disk_cache=/tmp/bazel-cache"
            PKG_BUILD: 1
            DESTDIR: /tmp/install
          command: |
            if [ ! -f BUILDS ]; then exit 0; fi
            cd src/cilium-proxy
            echo "<< parameters.version >>" > SOURCE_VERSION
            make bazel-bin/cilium-envoy
            ./bazel/get_workspace_status
            make install
            mv /tmp/install/usr/bin/cilium-envoy ../workspace/usr/bin/
      - persist_to_workspace:
          root: src/workspace
          paths:
            - "*"
  build-cilium-image-tools:
    parameters:
      version:
        type: string
    docker:
      - image: quay.io/cybozu/ubuntu-dev:22.04
    resource_class: 2xlarge+
    steps:
      - checkout
      - run:
          name: Check TAG file
          command: |
            c="$(./tag_exists cilium)"
            if [ "$c" = ng ]; then
                echo cilium > BUILDS
            fi
      - run:
          name: Install package dependencies
          environment:
            DEBIAN_FRONTEND: noninteractive
          command: |
            if [ ! -f BUILDS ]; then exit 0; fi
            cat > /etc/apt/sources.list \<< EOF
            deb [arch=amd64] http://archive.ubuntu.com/ubuntu jammy main restricted universe multiverse
            deb [arch=amd64] http://security.ubuntu.com/ubuntu jammy-updates main restricted universe multiverse
            deb [arch=amd64] http://security.ubuntu.com/ubuntu jammy-security main restricted universe multiverse
            deb [arch=amd64] http://archive.ubuntu.com/ubuntu jammy-backports main restricted universe multiverse
            deb [arch=arm64] http://ports.ubuntu.com/ jammy main restricted universe multiverse
            deb [arch=arm64] http://ports.ubuntu.com/ jammy-updates main restricted universe multiverse
            deb [arch=arm64] http://ports.ubuntu.com/ jammy-security main restricted universe multiverse
            deb [arch=arm64] http://ports.ubuntu.com/ jammy-backports main restricted universe multiverse
            EOF
            dpkg --add-architecture arm64
            apt-get update
            ln -fs /usr/share/zoneinfo/UTC /etc/localtime
            apt-get install -y --no-install-recommends \
              automake \
              binutils \
              binutils-aarch64-linux-gnu \
              bison \
              build-essential \
              ca-certificates \
              cmake \
              crossbuild-essential-arm64 \
              curl \
              flex \
              g++ \
              g++-aarch64-linux-gnu \
              gcc-9 \
              gcc-9-aarch64-linux-gnu \
              git \
              libelf-dev \
              libelf-dev:arm64 \
              libmnl-dev \
              libtool \
              make \
              ninja-build \
              pkg-config \
              python2 \
              python3 \
              python3-pip \
              unzip
            update-alternatives --install /usr/bin/python python /usr/bin/python2 1
            update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-9 2
            update-alternatives --install /usr/bin/aarch64-linux-gnu-gcc aarch64-linux-gnu-gcc /usr/bin/aarch64-linux-gnu-gcc-9 3
      - run:
          name: Download cilium/image-tools
          command: |
            mkdir -p src/workspace/bin src/workspace/usr/local/bin src/workspace/usr/lib src/image-tools
            if [ ! -f BUILDS ]; then exit 0; fi
            curl -sSLf https://github.com/cilium/image-tools/archive/<< parameters.version >>.tar.gz | \
              tar zxf - --strip-components 1 -C src/image-tools
      - run:
          name: Build llvm
          command: |
            if [ ! -f BUILDS ]; then exit 0; fi
            cd src/image-tools
            images/llvm/checkout-llvm.sh
            images/llvm/build-llvm-native.sh
            mv /out/linux/amd64/bin/clang /out/linux/amd64/bin/llc /out/linux/amd64/bin/llvm-objcopy ../workspace/bin
      - run:
          name: Build bpftool
          command: |
            if [ ! -f BUILDS ]; then exit 0; fi
            cd src/image-tools
            images/bpftool/checkout-linux.sh
            images/bpftool/build-bpftool-native.sh
            mv /out/linux/amd64/bin/bpftool ../workspace/usr/local/bin/
      - run:
          name: Build iproute2
          # The actual directory name of libbpf.tar.gz after extraction is cilium-libbpf in images/iproute2/checkout-libbpf.
          # So we replace libbpf with cilium-libbpf by sed.
          command: |
            if [ ! -f BUILDS ]; then exit 0; fi
            cd src/image-tools
            sed -i -e "s/libbpf-/cilium-libbpf-/g" images/iproute2/checkout-libbpf.sh
            images/iproute2/checkout-libbpf.sh
            images/iproute2/build-libbpf-native.sh
            images/iproute2/checkout-iproute2.sh
            images/iproute2/build-iproute2-native.sh
            mv /out/linux/amd64/lib64/libbpf* ../workspace/usr/lib/
            mv /out/linux/amd64/bin/ip /out/linux/amd64/bin/tc /out/linux/amd64/bin/ss ../workspace/usr/local/bin/
      - persist_to_workspace:
          root: src/workspace
          paths:
            - "*"
  build-cert-manager:
    parameters:
      repo:
        type: string
      version:
        type: string
    docker:
      - image: quay.io/cybozu/golang:1.20-jammy
    resource_class: xlarge
    steps:
      - checkout
      - run:
          name: Check TAG file
          command: |
            c="$(./tag_exists cert-manager)"
            if [ "$c" = ng ]; then
                echo cert-manager > BUILDS
            fi
      - run:
          name: Build cert-manager
          command: |
            mkdir -p src/workspace
            if [ ! -f BUILDS ]; then
                # fake for the next step
                cd src/workspace
                touch cainjector controller webhook LICENSE
                exit 0
            fi
            cd src
            git clone --depth 1 --branch v<< parameters.version >> << parameters.repo >>
            cd cert-manager
            # We use a dummy environment value(CTR=sleep) to pass checks for unnecessary tools
            make CTR=sleep _bin/server/controller-linux-amd64
            make CTR=sleep _bin/server/webhook-linux-amd64
            make CTR=sleep _bin/server/cainjector-linux-amd64
            mv _bin/server/controller-linux-amd64 ../workspace/controller
            mv _bin/server/webhook-linux-amd64 ../workspace/webhook
            mv _bin/server/cainjector-linux-amd64 ../workspace/cainjector
            mv LICENSE ../workspace
      - persist_to_workspace:
          root: src/workspace
          paths:
            - "*"
  build-admission:
    docker:
      - image: quay.io/cybozu/golang:1.20-jammy
    steps:
      - checkout
      - run: cd admission; make test
      - run: cd admission; make check-generate
      - run: cd admission; make build
      - persist_to_workspace:
          root: admission/bin
          paths:
            - neco-admission
  test-local-pv-provisioner:
    docker:
      - image: quay.io/cybozu/golang:1.20-jammy
    steps:
      - checkout
      - run: cd local-pv-provisioner; make check-generate
      - run: cd local-pv-provisioner; make test

workflows:
  main:
    jobs:
      - test:
          name: test-bmc-reverse-proxy
          directory: bmc-reverse-proxy
          go-image-tag: 1.21-jammy
      - test:
          name: test-ceph-extra-exporter
          directory: ceph-extra-exporter
      - test:
          name: test-envoy
          directory: envoy
      - test:
          name: test-heartbeat
          directory: heartbeat
          go-image-tag: 1.20-jammy
      - test-local-pv-provisioner
      - test:
          name: test-machines-endpoints
          directory: machines-endpoints
          go-image-tag: 1.21-jammy
      - test:
          name: test-s3gw
          directory: s3gw
          go-image-tag: 1.20-jammy
      - test:
          name: test-testhttpd
          directory: testhttpd/src
          go-image-tag: 1.21-jammy
      - build-admission
      - build:
          name: build-admission-image
          container-image: neco-admission
          dir: admission
          attach: true
          requires:
            - build-admission
      - build:
          name: build-alertmanager
          container-image: alertmanager
          scan: true
      - build:
          name: build-argocd
          container-image: argocd
          scan: true
      - build:
          name: build-bird
          container-image: bird
          scan: true
      - build:
          name: build-blackbox_exporter
          container-image: blackbox_exporter
          scan: true
      - build:
          name: build-bmc-reverse-proxy
          container-image: bmc-reverse-proxy
      - build:
          name: build-cadvisor
          container-image: cadvisor
      - build-ceph:
          version: 17.2.6
      - build:
          name: build-ceph-container
          container-image: ceph
          attach: true
          dir: ceph
          requires:
            - build-ceph
      - build:
          name: build-ceph-extra-exporter
          container-image: ceph-extra-exporter
      - build:
          name: build-cephcsi
          container-image: cephcsi
      - build-cert-manager:
          #repo: https://github.com/cert-manager/cert-manager
          repo: https://github.com/cybozu-go/cert-manager
          version: 1.13.2-neco-longtimeout.1
      - build:
          name: build-cert-manager-container
          container-image: cert-manager
          attach: true
          dir: cert-manager
          requires:
            - build-cert-manager
          scan: true
      - build:
          name: build-chrony
          container-image: chrony
      - build-cilium-envoy:
          version: ad831bdec4c93feeb2378aa9e1847c936ada6ef7
      - build-cilium-image-tools:
          # https://github.com/cilium/image-tools/commits/master
          # From this commit, cilium/image-tools stops building iproute2 because of cilium v1.14 doesn't depend on iproute2.
          # But, we use v1.13.6, so we still have to build iproute2.
          # So we use an older version of image-tools which builds iproute2.
          # https://github.com/cilium/image-tools/commit/8a2f099f14330221848c14808f3208e4dd2469bb
          version: ff22ba3bff1010f4a2dd76ede789663c3beaf8d2
      - build:
          name: build-cilium
          container-image: cilium
          attach: true
          dir: cilium
          requires:
            - build-cilium-envoy
            - build-cilium-image-tools
          scan: true
      - build:
          name: build-cilium-operator-generic
          container-image: cilium-operator-generic
      - build:
          name: build-cilium-certgen
          container-image: cilium-certgen
      - build:
          name: build-configmap-reload
          container-image: configmap-reload
      - build:
          name: build-contour
          container-image: contour
      - build:
          name: build-csi-attacher
          container-image: csi-attacher
      - build:
          name: build-csi-node-driver-registrar
          container-image: csi-node-driver-registrar
      - build:
          name: build-csi-provisioner
          container-image: csi-provisioner
      - build:
          name: build-csi-resizer
          container-image: csi-resizer
      - build:
          name: build-csi-snapshotter
          container-image: csi-snapshotter
      - build:
          name: build-dex
          container-image: dex
          scan: true
      - build-envoy:
          version: 1.28.0
          bazel-version: 6.3.2
      - build:
          name: build-envoy-container
          container-image: envoy
          attach: true
          dir: envoy
          requires:
            - build-envoy
          scan: true
      - build:
          name: build-external-dns
          container-image: external-dns
      - buildx:
          name: build-golang-1.20-focal
          container-image: golang
          dir: golang-all/golang-1.20-focal
      - buildx:
          name: build-golang-1.20-jammy
          container-image: golang
          dir: golang-all/golang-1.20-jammy
      - buildx:
          name: build-golang-1.21-focal
          container-image: golang
          dir: golang-all/golang-1.21-focal
      - buildx:
          name: build-golang-1.21-jammy
          container-image: golang
          dir: golang-all/golang-1.21-jammy
      - build:
          name: build-gorush
          container-image: gorush
      - build:
          name: build-go-ipfs
          container-image: go-ipfs
      - build:
          name: build-grafana
          container-image: grafana
          resource-class: large
          scan: true
      - build:
          name: build-grafana_plugins_init
          container-image: grafana_plugins_init
          scan: true
      - build:
          name: build-grafana-operator
          container-image: grafana-operator
          scan: true
      - build:
          name: build-heartbeat
          container-image: heartbeat
          scan: true
      - build:
          name: build-hubble
          container-image: hubble
      - build:
          name: build-hubble-relay
          container-image: hubble-relay
      - build:
          name: build-hubble-ui
          container-image: hubble-ui
          targets: frontend backend
      - build:
          name: build-ipfs-cluster
          container-image: ipfs-cluster
      - build:
          name: build-kube-metrics-adapter
          container-image: kube-metrics-adapter
      - build:
          name: build-kube-state-metrics
          container-image: kube-state-metrics
      - build:
          name: build-kube-storage-version-migrator
          container-image: storage-version-migration
          dir: kube-storage-version-migrator
          targets: initializer migrator trigger
      - build:
          name: build-local-pv-provisioner
          container-image: local-pv-provisioner
      - build:
          name: build-loki
          container-image: loki
          scan: true
      - build:
          name: build-machines-endpoints
          container-image: machines-endpoints
      - build:
          name: build-memcached
          container-image: memcached
          scan: true
      - build:
          name: build-memcached-exporter
          container-image: memcached-exporter
      - build:
          name: build-meows-dctest-runner
          container-image: meows-dctest-runner
          scan: true
      - build:
          name: build-meows-neco-runner
          container-image: meows-neco-runner
          scan: true
      - build:
          name: build-moco-switchover-downtime-monitor
          container-image: moco-switchover-downtime-monitor
      - build:
          name: build-nerdctl
          container-image: nerdctl
      - build:
          name: build-opentelemetry-collector
          container-image: opentelemetry-collector
          scan: true
      - build:
          name: build-pomerium
          container-image: pomerium
          scan: true
      - build:
          name: build-prometheus-adapter
          container-image: prometheus-adapter
      - build:
          name: build-prometheus-config-reloader
          container-image: prometheus-config-reloader
          scan: true
      - build:
          name: build-promtail
          container-image: promtail
          scan: true
      - build:
          name: build-promtail-debug
          container-image: promtail-debug
      - build:
          name: build-pushgateway
          container-image: pushgateway
      - build:
          name: build-redis
          container-image: redis
          scan: true
      - build:
          name: build-registry
          container-image: registry
          scan: true
      - build:
          name: build-rook
          container-image: rook
      - build:
          name: build-s3gw
          container-image: s3gw
      - build:
          name: build-sealed-secrets
          container-image: sealed-secrets
      - build:
          name: build-serf
          container-image: serf
          scan: true
      - build:
          name: build-squid
          container-image: squid
          scan: true
      - build:
          name: build-teleport-node
          container-image: teleport-node
          scan: true
      - build:
          name: build-tempo
          container-image: tempo
          scan: true
      - build:
          name: build-testhttpd
          container-image: testhttpd
      - build:
          name: build-unbound
          container-image: unbound
      - build:
          name: build-vault
          container-image: vault
      - build:
          name: build-victoriametrics-operator
          container-image: victoriametrics-operator
      - build:
          name: build-victoriametrics
          container-image: victoriametrics
          targets: vmsingle vmagent vmalert vmbackup vmrestore vmctl vminsert vmselect vmstorage
          scan: true
