name: Update Go Versions

on:
  schedule:
    - cron: '0 22 * * 0-4' # 毎日7:00 JST

jobs:
  generate-matrix:
    runs-on: ubuntu-22.04
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Get latest stable Go versions
        id: get-go-versions
        run: |
          stable_golang_versions=($(curl -sSL https://go.dev/dl/?mode=json | jq -r '[.[] | select(.stable == true)][0,1] | .version | sub("^go"; "")'))
          if [ -z "$stable_golang_versions" ]; then
            echo "No stable Go version found"
            exit 1
          fi
          list=$(echo "[\"${stable_golang_versions[0]}\",\"${stable_golang_versions[1]}\"]" | jq -c)
          echo "::set-output name=matrix::${list}"
      - name: Set matrix output
        id: set-matrix
        run: echo "matrix=${{ steps.get-go-versions.outputs.matrix }}"

  update-go-versions:
    needs: generate-matrix
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        go_version: ${{ needs.generate-matrix.outputs.matrix }}
    env:
      GH_TOKEN: ${{ secrets.CYBOZU_NECO_PAT }}
      UBUNTU_CODENAME: jammy
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
